# Backtest Engine Python

## Introduction
This project is a Python-based backtesting framework designed to simulate trading strategies. It provides a modular structure with components for managing market data, portfolio state, trade execution, and strategy logic. The framework supports both long and short positions, enabling comprehensive strategy evaluation.

## Framework Overview
The framework consists of the following key components:

### 1. `Candle`
Represents a single OHLCV (Open, High, Low, Close, Volume) bar of market data.
- **Attributes**:
  - `symbol`: The trading symbol (e.g., "AAPL").
  - `timestamp`: The time of the candle.
  - `open`: The opening price.
  - `high`: The highest price.
  - `low`: The lowest price.
  - `close`: The closing price.
  - `volume`: The trading volume.
- **Usage**: Candles are used as input data for the backtest engine and strategies.

### 2. `OrderIntent`
Represents an order generated by a strategy.
- **Attributes**:
  - `symbol`: The trading symbol.
  - `side`: The order side (`BUY` or `SELL`).
  - `quantity`: The number of units to trade.
  - `order_type`: The type of order (default is `MARKET`).
  - `limit_price`: The price for limit orders (optional).
- **Usage**: Strategies return a list of `OrderIntent` objects to indicate desired trades.

### 3. `Trade`
Represents an executed trade.
- **Attributes**:
  - `symbol`: The trading symbol.
  - `quantity`: The number of units traded (positive for buy, negative for sell).
  - `price`: The execution price.
  - `fee`: The trading fee.
  - `timestamp`: The time of the trade.
- **Usage**: Trades are created by the broker when processing orders.

### 4. `Position`
Represents an open position in the portfolio.
- **Attributes**:
  - `symbol`: The trading symbol.
  - `side`: Indicates whether the position is `LONG` or `SHORT`.
  - `quantity`: The number of units held (positive for long, negative for short).
  - `entry_price`: The average price at which the position was entered.
  - `realized_pnl`: Tracks the profit or loss realized from closing parts of the position.
- **Methods**:
  - `update(trade_price, trade_quantity)`: Updates the position based on a trade.
- **Usage**: Positions are managed by the `PortfolioState` class.

### 5. `PortfolioState`
Manages the overall portfolio, including cash and positions.
- **Attributes**:
  - `cash`: The available cash in the portfolio.
  - `positions`: A dictionary of `Position` objects, keyed by symbol.
- **Methods**:
  - `apply_trade(trade)`: Updates the portfolio based on a trade.
  - `build_snapshot(price_by_symbol, timestamp)`: Creates a snapshot of the portfolio, including unrealized PnL for all positions.
- **Usage**: The broker interacts with the portfolio to apply trades and generate snapshots.

### 6. `BacktestBroker`
Simulates a broker for backtesting, supporting long and short positions.
- **Attributes**:
  - `portfolio`: The `PortfolioState` object.
  - `fee_rate`: The trading fee rate.
- **Methods**:
  - `process_bar(candle, order_intents)`: Processes a single bar (candle) and executes the given order intents.
  - `get_snapshot(candle)`: Returns a snapshot of the portfolio before processing orders.
- **Usage**: The broker handles trade execution and portfolio updates.

### 7. `BaseStrategy`
Defines the interface for trading strategies.
- **Methods**:
  - `on_bar(context)`: Called for each new bar of market data. Returns a list of `OrderIntent` objects.
- **Usage**: Users implement their own strategies by subclassing `BaseStrategy`.

### 8. `BacktestEngine`
Coordinates the backtesting process.
- **Attributes**:
  - `broker`: The `BacktestBroker` object.
  - `strategy`: The strategy to be tested.
- **Methods**:
  - `run(candles)`: Runs the backtest on the given market data.
- **Usage**: The engine drives the backtest by feeding market data to the strategy and broker.

## How It Works
1. **Market Data**: The engine processes a sequence of `Candle` objects.
2. **Strategy Execution**: For each candle, the strategy generates `OrderIntent` objects.
3. **Trade Execution**: The broker processes the orders and updates the portfolio.
4. **Snapshots**: The broker generates portfolio snapshots after each bar.

## Example Workflow
1. Define a strategy by subclassing `BaseStrategy`.
2. Create a list of `Candle` objects to represent market data.
3. Initialize the `BacktestBroker`, `BaseStrategy`, and `BacktestEngine`.
4. Run the backtest using the `engine.run(candles)` method.
5. Analyze the results using portfolio snapshots or the visualization tool.

## Visualization
A separate script, `visualize_backtest.py`, is provided to plot the results of the backtest, including price movements and portfolio equity over time.

## Installation
1. Clone the repository:
   ```bash
   git clone https://github.com/ArthurHtr/backtest-engine-python.git
   ```
2. Navigate to the project directory:
   ```bash
   cd backtest-engine-python
   ```
3. Create and activate a virtual environment:
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   ```
4. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```

## License
This project is licensed under the MIT License.